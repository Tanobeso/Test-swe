name: Compilazione LaTeX e pubblicazione su GitHub Pages
on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: texlive/texlive:latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Compila verbali interni
        run: |
          for file in Verbali/Interni/Latex/*.tex; do
            if [ -f "$file" ]; then
              echo "Compilo $file..."
              filename=$(basename "$file" .tex)
              basedir=$(dirname "$file")
              
              # Compila nella cartella temporanea
              cd "$basedir"
              latexmk -pdf -interaction=nonstopmode -file-line-error \
                -aux-directory=/tmp/latex_aux \
                "$(basename $file)" || true
              
              # Sposta solo il PDF nella cartella finale
              if [ -f "${filename}.pdf" ]; then
                mkdir -p "$(pwd)/../../../Verbali/Interni"
                mv "${filename}.pdf" "$(pwd)/../../../Verbali/Interni/"
                echo "âœ“ PDF spostato in Verbali/Interni/${filename}.pdf"
              fi
              
              cd - > /dev/null
            fi
          done
      
      - name: Compila verbali esterni
        run: |
          for file in Verbali/Esterni/Latex/*.tex; do
            if [ -f "$file" ]; then
              echo "Compilo $file..."
              filename=$(basename "$file" .tex)
              basedir=$(dirname "$file")
              
              # Compila nella cartella temporanea
              cd "$basedir"
              latexmk -pdf -interaction=nonstopmode -file-line-error \
                -aux-directory=/tmp/latex_aux \
                "$(basename $file)" || true
              
              # Sposta solo il PDF nella cartella finale
              if [ -f "${filename}.pdf" ]; then
                mkdir -p "$(pwd)/../../../Verbali/Esterni"
                mv "${filename}.pdf" "$(pwd)/../../../Verbali/Esterni/"
                echo "âœ“ PDF spostato in Verbali/Esterni/${filename}.pdf"
              fi
              
              cd - > /dev/null
            fi
          done
      
      - name: Verifica PDFs generati
        run: |
          echo "=== PDFs Verbali Interni ==="
          ls -lh Verbali/Interni/*.pdf 2>/dev/null || echo "Nessun PDF interno trovato"
          echo "=== PDFs Verbali Esterni ==="
          ls -lh Verbali/Esterni/*.pdf 2>/dev/null || echo "Nessun PDF esterno trovato"
      
      - name: Prepara output per GitHub Pages
        run: |
          mkdir -p output/verbali_interni
          mkdir -p output/verbali_esterni
          
          # Copia il file index.html e il logo
          cp .github/templates/index.html output/
          cp .github/templates/logo.png output/ 2>/dev/null || echo "âš ï¸ Logo non trovato"
          
          # Copia TUTTI i PDF nella cartella output (compilati + giÃ  esistenti)
          if ls Verbali/Interni/*.pdf 1> /dev/null 2>&1; then
            cp Verbali/Interni/*.pdf output/verbali_interni/
            echo "âœ“ Copiati $(ls Verbali/Interni/*.pdf | wc -l) PDF interni"
          fi
          
          if ls Verbali/Esterni/*.pdf 1> /dev/null 2>&1; then
            cp Verbali/Esterni/*.pdf output/verbali_esterni/
            echo "âœ“ Copiati $(ls Verbali/Esterni/*.pdf | wc -l) PDF esterni"
          fi
      
      - name: Carica PDFs come artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pdfs-generati
          path: |
            Verbali/Interni/*.pdf
            Verbali/Esterni/*.pdf
          if-no-files-found: warn
      
      - name: Commit PDFs su main
        run: |
          git config --global --add safe.directory /__w/Test-swe/Test-swe
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add Verbali/Interni/*.pdf Verbali/Esterni/*.pdf
          git diff --staged --quiet || git commit -m "ðŸ“„ Aggiorna PDFs compilati [skip ci]"
          git push
      
      - name: Pubblica su GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output